<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tp.mes.app.inventory.mapper.InventoryTransactionMapper">
    
    <!-- Result Map -->
    <resultMap id="transactionResultMap" type="com.tp.mes.app.inventory.model.InventoryTransaction">
        <id property="transactionId" column="transaction_id"/>
        <result property="inventoryId" column="inventory_id"/>
        <result property="transactionType" column="transaction_type"/>
        <result property="quantity" column="quantity"/>
        <result property="transactionReason" column="transaction_reason"/>
        <result property="referenceNo" column="reference_no"/>
        <result property="notes" column="notes"/>
        <result property="performedBy" column="performed_by"/>
        <result property="transactionDate" column="transaction_date"/>
        <result property="itemCode" column="item_code"/>
        <result property="itemName" column="item_name"/>
    </resultMap>
    
    <!-- 모든 거래 내역 조회 -->
    <select id="findAll" resultMap="transactionResultMap">
        SELECT t.transaction_id, t.inventory_id, t.transaction_type, 
               t.quantity, t.transaction_reason, t.reference_no,
               t.notes, t.performed_by, t.transaction_date,
               i.item_code, i.item_name
        FROM tp_inventory_transactions t
        LEFT JOIN tp_inventory i ON t.inventory_id = i.inventory_id
        ORDER BY t.transaction_date DESC
    </select>
    
    <!-- 특정 재고의 거래 내역 조회 -->
    <select id="findByInventoryId" resultMap="transactionResultMap">
        SELECT t.transaction_id, t.inventory_id, t.transaction_type, 
               t.quantity, t.transaction_reason, t.reference_no,
               t.notes, t.performed_by, t.transaction_date,
               i.item_code, i.item_name
        FROM tp_inventory_transactions t
        LEFT JOIN tp_inventory i ON t.inventory_id = i.inventory_id
        WHERE t.inventory_id = #{inventoryId}
        ORDER BY t.transaction_date DESC
    </select>
    
    <!-- 최근 거래 내역 조회 -->
    <select id="findRecent" resultMap="transactionResultMap">
        SELECT t.transaction_id, t.inventory_id, t.transaction_type, 
               t.quantity, t.transaction_reason, t.reference_no,
               t.notes, t.performed_by, t.transaction_date,
               i.item_code, i.item_name
        FROM tp_inventory_transactions t
        LEFT JOIN tp_inventory i ON t.inventory_id = i.inventory_id
        ORDER BY t.transaction_date DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>
    
    <!-- 거래 내역 등록 -->
    <insert id="insert" parameterType="com.tp.mes.app.inventory.model.InventoryTransaction"
            useGeneratedKeys="true" keyProperty="transactionId" keyColumn="transaction_id">
        INSERT INTO tp_inventory_transactions (
            inventory_id, transaction_type, quantity, transaction_reason,
            reference_no, notes, performed_by, transaction_date
        ) VALUES (
            #{inventoryId}, #{transactionType}, #{quantity}, #{transactionReason},
            #{referenceNo}, #{notes}, #{performedBy}, 
            NVL(#{transactionDate}, CURRENT_TIMESTAMP)
        )
    </insert>
    
</mapper>
